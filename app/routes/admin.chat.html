<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Omni Chat Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; margin: 0; display:flex; height:100vh; }
      .left { width: 320px; border-right:1px solid #eee; padding:12px; overflow:auto; }
      .right { flex:1; display:flex; flex-direction:column; }
      .head { padding:12px; border-bottom:1px solid #eee; font-weight:700; }
      .msgs { flex:1; padding:12px; overflow:auto; background:#fafafa; }
      .input { display:flex; gap:8px; padding:12px; border-top:1px solid #eee; background:#fff; }
      .input input { flex:1; padding:10px; border:1px solid #ddd; border-radius:10px; }
      .input button { padding:10px 14px; border:none; border-radius:10px; background:#111827; color:#fff; font-weight:700; cursor:pointer; }
      .item { padding:8px; border-radius:8px; cursor:pointer; margin-bottom:6px; border:1px solid #eee; }
      .item.active { background:#eef2ff; border-color:#c7d2fe; }
      .bubble { max-width:70%; padding:8px 10px; border-radius:12px; margin:6px 0; font-size:14px; line-height:1.3; }
      .them { background:#e6f2ff; margin-right:auto; }
      .me { background:#f3f4f6; margin-left:auto; }
    </style>
  </head>
  <body>
    <div class="left">
      <h3>Sessions</h3>
      <div id="sessions"></div>
    </div>
    <div class="right">
      <div class="head">Chat</div>
      <div id="msgs" class="msgs"></div>
      <div class="input">
        <input id="msg" placeholder="Type a reply…" />
        <button id="send">Send</button>
      </div>
    </div>

    <script>
      const API = "https://omnichannel-communication-3d7329b35a37.herokuapp.com/api/chat";
      const STORE = ""; // optional filter like "apiappstore.myshopify.com"
      const sessionsEl = document.getElementById('sessions');
      const msgsEl = document.getElementById('msgs');
      const input = document.getElementById('msg');
      const sendBtn = document.getElementById('send');

      let currentSession = null;
      let since = null;

      function bubble(text, who){
        const b = document.createElement('div');
        b.className = 'bubble ' + (who === 'owner' ? 'me' : 'them');
        b.textContent = text;
        msgsEl.appendChild(b);
        msgsEl.scrollTop = msgsEl.scrollHeight;
      }

      async function loadSessions(){
        const url = new URL(API + "/sessions");
        if (STORE) url.searchParams.set("store_domain", STORE);
        const r = await fetch(url.toString());
        const data = await r.json();
        sessionsEl.innerHTML = "";
        (data.sessions || []).forEach(s => {
          const d = document.createElement('div');
          d.className = 'item' + (currentSession === s.sessionId ? ' active' : '');
          d.textContent = s.storeDomain + " • " + s.sessionId;
          d.onclick = () => { currentSession = s.sessionId; since = null; renderSessions(); loadMessages(true); };
          sessionsEl.appendChild(d);
        });
      }
      function renderSessions(){
        Array.from(sessionsEl.children).forEach(ch => {
          ch.classList.toggle('active', ch.textContent.includes(currentSession));
        });
      }

      async function loadMessages(clear){
        if (!currentSession) return;
        const url = new URL(API + "/by-session");
        url.searchParams.set("store_domain", STORE || "");
        url.searchParams.set("session_id", currentSession);
        const r = await fetch(url.toString());
        const data = await r.json();
        if (clear) msgsEl.innerHTML = "";
        (data.messages || []).forEach(m => bubble(m.text, m.sender));
        if (data.messages?.length) since = data.messages[data.messages.length-1].createdAt;
      }

      async function send(){
        if (!currentSession) return;
        const text = input.value.trim(); if (!text) return;
        input.value = "";
        bubble(text, 'owner');
        await fetch(API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            store_domain: STORE || (currentSession.split(':')[0] || ''), // or keep STORE blank
            session_id: currentSession,
            message: text,
            sender: 'owner'
          })
        });
      }

      sendBtn.onclick = send;
      input.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

      // initial
      loadSessions();
      setInterval(loadSessions, 5000);
      setInterval(()=> loadMessages(false), 3000);
    </script>
  </body>
</html>
