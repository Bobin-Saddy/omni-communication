<div id="oc-chat" data-store="{{ shop.domain }}" data-endpoint="https://omnichannel-communication-3d7329b35a37.herokuapp.com/api/chat" class="oc-chat-wrap" style="all: initial;">
  <style>
    .oc-chat-container {
      position: fixed; 
      right: 16px; 
      bottom: 80px; 
      width: 320px; 
      max-height: 70vh; 
      display: flex; 
      flex-direction: column; 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 8px 30px rgba(0,0,0,.15); 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
      overflow: hidden;
      transform: translateY(20px); 
      opacity: 0; 
      pointer-events: none;
      transition: all .35s ease;
    }
    .oc-chat-container.oc-active {
      transform: translateY(0); 
      opacity: 1; 
      pointer-events: auto;
    }
    .oc-chat-header { 
      padding: 14px 16px; 
      font-weight: 600; 
      font-size: 15px; 
      background: {{ block.settings.header_bg | default: "linear-gradient(135deg,#2563eb,#1d4ed8)" }}; 
      color: {{ block.settings.header_fg | default: "#ffffff" }}; 
      border-top-left-radius: 20px; 
      border-top-right-radius: 20px;
      display: flex; 
      align-items: center; 
      justify-content: space-between;
    }
    .oc-chat-messages { 
      padding: 12px; 
      overflow-y: auto; 
      flex: 1; 
      background: #f9fafb; 
    }
    .oc-chat-input { 
      display: flex; 
      gap: 8px; 
      border-top: 1px solid #eee; 
      padding: 10px; 
      background: #fff; 
    }
    .oc-chat-input input { 
      flex: 1; 
      border: 1px solid #ddd; 
      border-radius: 20px; 
      padding: 10px 14px; 
      outline: none; 
      font-size: 14px;
    }
    .oc-chat-input button { 
      border: none; 
      border-radius: 50%; 
      width: 42px; 
      height: 42px; 
      cursor: pointer; 
      background: {{ block.settings.btn_bg | default: "linear-gradient(135deg,#2563eb,#1d4ed8)" }}; 
      color: {{ block.settings.btn_fg | default: "#ffffff" }}; 
      font-weight: 600;
      display:flex; 
      align-items:center; 
      justify-content:center;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      transition: transform .2s;
    }
    .oc-chat-input button:hover { transform: scale(1.05); }

    .oc-bubble { 
      max-width: 75%; 
      padding: 10px 14px; 
      border-radius: 16px; 
      margin: 6px 0; 
      font-size: 14px; 
      line-height: 1.4; 
      word-break: break-word; 
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
    }
    .oc-me { 
      background: #2563eb; 
      color: #fff; 
      margin-left: auto; 
      border-bottom-right-radius: 4px; 
    }
    .oc-them { 
      background: #e5e7eb; 
      margin-right: auto; 
      border-bottom-left-radius: 4px;
    }

    .oc-chat-toggle { 
      position: fixed; 
      right: 16px; 
      bottom: 16px; 
      background: {{ block.settings.btn_bg | default: "linear-gradient(135deg,#2563eb,#1d4ed8)" }}; 
      color: {{ block.settings.btn_fg | default: "#ffffff" }}; 
      border: none; 
      border-radius: 50%; 
      width: 56px; 
      height: 56px; 
      cursor: pointer; 
      box-shadow: 0 8px 24px rgba(0,0,0,.2); 
      font-size: 22px;
      display:flex; 
      align-items:center; 
      justify-content:center;
      transition: transform .25s;
    }
    .oc-chat-toggle:hover { transform: scale(1.08); }

    @media(max-width:480px){
      .oc-chat-container { width: 100%; right: 0; bottom: 0; height: 100%; max-height: none; border-radius: 0; }
    }
  </style>

  <!-- Floating toggle -->
  <button class="oc-chat-toggle" aria-label="Open chat">ðŸ’¬</button>

  <!-- Chat box -->
  <div class="oc-chat-container">
    <div class="oc-chat-header">
      {{ block.settings.header_title | default: "ðŸ’¬ Need help? Chat with us!" }}
      <button style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;" class="oc-close">Ã—</button>
    </div>
    <div class="oc-chat-messages"></div>
    <div class="oc-chat-input">
      <input type="text" placeholder="{{ block.settings.placeholder | default: 'Type your messageâ€¦' }}" />
      <button type="button">âž¤</button>
    </div>
  </div>

<script>
(function(){
  const root = document.currentScript.closest('#oc-chat');
  const store = root.dataset.store;
  const endpoint = root.dataset.endpoint;

  const btnToggle = root.querySelector('.oc-chat-toggle');
  const panel = root.querySelector('.oc-chat-container');
  const list = root.querySelector('.oc-chat-messages');
  const input = root.querySelector('.oc-chat-input input');
  const sendBtn = root.querySelector('.oc-chat-input button');
  const closeBtn = root.querySelector('.oc-close');

  const sidKey = 'oc_chat_sid';
  function uuid() { return 'xxxxxxxyxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16); }); }
  let SID = localStorage.getItem(sidKey);
  if (!SID) { SID = uuid(); localStorage.setItem(sidKey, SID); }

  // toggle
  btnToggle.addEventListener('click', ()=> {
    panel.classList.add('oc-active');
    btnToggle.style.display="none";
  });
  closeBtn.addEventListener('click', ()=> {
    panel.classList.remove('oc-active');
    btnToggle.style.display="flex";
  });

  function appendBubble(text, sender){
    const b = document.createElement('div');
    b.className = 'oc-bubble ' + (sender==='customer'?'oc-me':'oc-them');
    b.textContent = text;
    list.appendChild(b);
    list.scrollTop = list.scrollHeight;
  }

  async function sendMessage(){
    const msg = (input.value||'').trim();
    if(!msg) return;
    appendBubble(msg,'customer');
    input.value='';
    try{
      await fetch(endpoint,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({storeDomain:store,sessionId:SID,sender:'customer',message:msg})
      });
    }catch(e){console.warn('send error',e);}
  }

  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', e=>{if(e.key==='Enter') sendMessage();});

  let lastISO=null;
  async function poll(){
    try{
      const url=new URL(endpoint);
      url.searchParams.set('storeDomain',store);
      url.searchParams.set('sessionId',SID);
      if(lastISO) url.searchParams.set('since',lastISO);
      const r=await fetch(url.toString());
      const data=await r.json();
      if(data && data.ok && Array.isArray(data.messages)){
        data.messages.forEach(m=>{
          appendBubble(m.text,m.sender==='customer'?'customer':'owner');
          lastISO=m.createdAt;
        });
      }
    }catch(e){console.warn(e);}
  }

  (async function init(){
    const url=new URL(endpoint);
    url.searchParams.set('storeDomain',store);
    url.searchParams.set('sessionId',SID);
    const r=await fetch(url.toString());
    const data=await r.json();
    if(data && data.ok && Array.isArray(data.messages)){
      data.messages.forEach(m=>appendBubble(m.text,m.sender==='customer'?'customer':'owner'));
      if(data.messages.length) lastISO=data.messages[data.messages.length-1].createdAt;
    }
    setInterval(poll,3000);
  })();
})();
</script>
</div>


{% schema %}
{
  "name": "Omni Chat Widget",
  "target": "section",
  "settings": [
    { "type": "text", "id": "header_title", "label": "Header title", "default": "Need help? Chat with us!" },
    { "type": "text", "id": "toggle_label", "label": "Floating button label", "default": "Chat" },
    { "type": "text", "id": "placeholder", "label": "Input placeholder", "default": "Type your messageâ€¦" },
    { "type": "color", "id": "header_bg", "label": "Header background", "default": "#111827" },
    { "type": "color", "id": "header_fg", "label": "Header text color", "default": "#ffffff" },
    { "type": "color", "id": "btn_bg", "label": "Send/Button background", "default": "#2563eb" },
    { "type": "color", "id": "btn_fg", "label": "Send/Button text", "default": "#ffffff" }
  ]
}
{% endschema %}
